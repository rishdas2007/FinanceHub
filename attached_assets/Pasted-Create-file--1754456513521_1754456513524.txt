Create file                                                                                                                                                                                                                                                                  ‚îÇ
‚îÇ ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ ‚îÇ
‚îÇ ‚îÇ ../FinanceHub_App_v4/server/services/zscore-technical-service-optimized.ts                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ import { db } from '../db';                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ import {                                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ   zscoreTechnicalIndicators,                                                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ   rollingStatistics,                                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ   technicalIndicators,                                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ   historicalStockData,                                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ   historicalSectorData,                                                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ   vixData                                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ } from '@shared/schema';                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ import { desc, eq, and, gte, sql, lte } from 'drizzle-orm';                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ import { logger } from '../middleware/logging';                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ export interface ZScoreIndicators {                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ   symbol: string;                                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ   date: Date;                                                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   // Original indicators                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ   rsi: number | null;                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   macd: number | null;                                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ   percentB: number | null;                                                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ   atr: number | null;                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   priceChange: number | null;                                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ   maTrend: number | null;                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   // Z-Score normalized indicators                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ   rsiZScore: number | null;                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ   macdZScore: number | null;                                                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ   bollingerZScore: number | null;                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ   atrZScore: number | null;                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ   priceMomentumZScore: number | null;                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   maTrendZScore: number | null;                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   // Composite signal                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   compositeZScore: number | null;                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ   signal: 'BUY' | 'SELL' | 'HOLD';                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ   signalStrength: number | null;                                                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ export interface ZScoreWeights {                                                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ   rsi: number;                                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ   macd: number;                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   bollinger: number;                                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ   maTrend: number;                                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ   priceMomentum: number;                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ   atr: number;                                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ class OptimizedZScoreTechnicalService {                                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private static instance: OptimizedZScoreTechnicalService;                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   // OPTIMIZED Z-Score Weights - Reduced redundancy, enhanced reliability                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private readonly weights: ZScoreWeights = {                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     rsi: 0.25,           // Reduced from 35% - less noise                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ     macd: 0.35,          // Increased from 30% - primary trend signal                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     bollinger: 0.15,     // Reduced from 20% - less contrarian fighting                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     maTrend: 0.20,       // Increased from 15% - stronger trend confirmation                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ     priceMomentum: 0.05, // Reduced from 10% - minimize noise                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     atr: 0.00            // Volatility modifier only, not directional                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   };                                                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   // OPTIMIZED Thresholds - More actionable signals, volatility-adjusted                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private readonly BASE_BUY_THRESHOLD = 0.75;    // Reduced from 1.0                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private readonly BASE_SELL_THRESHOLD = -0.75;  // Reduced from -1.0                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private readonly STRONG_BUY_THRESHOLD = 1.5;   // Reduced from 1.96                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private readonly STRONG_SELL_THRESHOLD = -1.5; // Reduced from -1.96                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private readonly ZSCORE_WINDOW = 63; // Keep 3-month window                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   public static getInstance(): OptimizedZScoreTechnicalService {                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (!OptimizedZScoreTechnicalService.instance) {                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ       OptimizedZScoreTechnicalService.instance = new OptimizedZScoreTechnicalService();                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     return OptimizedZScoreTechnicalService.instance;                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * ENHANCED: Volatility-adjusted thresholds based on VIX level                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private async getVolatilityAdjustedThresholds(): Promise<{ buy: number, sell: number }> {                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ     try {                                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Get current VIX level                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const latestVix = await db.select()                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .from(vixData)                                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .orderBy(desc(vixData.timestamp))                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .limit(1);                                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const vixLevel = latestVix[0] ? parseFloat(latestVix[0].vixValue?.toString() || '20') : 20;                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Adjust thresholds based on volatility regime                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       if (vixLevel < 15) {                                                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Very low volatility - more sensitive thresholds                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return { buy: 0.5, sell: -0.5 };                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ       } else if (vixLevel < 20) {                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Low volatility - slightly more sensitive                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return { buy: 0.6, sell: -0.6 };                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ       } else if (vixLevel > 35) {                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // High volatility - require stronger signals                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return { buy: 1.2, sell: -1.2 };                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ       } else if (vixLevel > 25) {                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Elevated volatility - moderately higher thresholds                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return { buy: 0.9, sell: -0.9 };                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ       } else {                                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Normal volatility - optimized base thresholds                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return { buy: this.BASE_BUY_THRESHOLD, sell: this.BASE_SELL_THRESHOLD };                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ       }                                                                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     } catch (error) {                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       logger.warn('Could not fetch VIX data, using base thresholds', error);                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ       return { buy: this.BASE_BUY_THRESHOLD, sell: this.BASE_SELL_THRESHOLD };                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * Calculate Z-Score: (Current Value - Mean) / Standard Deviation                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * Returns null for invalid calculations to maintain statistical integrity                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private calculateZScore(currentValue: number, mean: number, stdDev: number): number | null {                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (stdDev === 0 || isNaN(stdDev) || isNaN(currentValue) || isNaN(mean) || !isFinite(currentValue)) {                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       return null; // Return null instead of 0 for invalid calculations                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     return (currentValue - mean) / stdDev;                                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * OPTIMIZED: Enhanced z-score to signal conversion with statistical confidence                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private zscoreToSignal(zscore: number): number {                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (zscore === null || !isFinite(zscore)) return 0;                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // Enhanced statistical thresholds for better signal quality                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (Math.abs(zscore) > 2.0) return Math.sign(zscore) * 1.0;    // 95%+ confidence                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (Math.abs(zscore) > 1.5) return Math.sign(zscore) * 0.8;    // Strong signal                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (Math.abs(zscore) > 1.0) return Math.sign(zscore) * 0.6;    // Moderate signal                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (Math.abs(zscore) > 0.5) return Math.sign(zscore) * 0.4;    // Weak signal                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ     return zscore * 0.2; // Very weak - linear scaling                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * Apply ATR as volatility signal strength modifier (unchanged)                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private applyAtrModifier(compositeZScore: number, atrZScore: number | null): number {                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (atrZScore === null || !isFinite(atrZScore)) {                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       return compositeZScore;                                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // High ATR (volatility) reduces signal confidence                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ     // Low ATR (stability) maintains or slightly enhances signal                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ     const atrModifier = Math.max(0.7, 1.0 - Math.abs(atrZScore) * 0.1);                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ     return compositeZScore * atrModifier;                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * MAIN CALCULATION METHOD - Enhanced with optimized weights and dynamic thresholds                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   async calculateZScoreForSymbol(symbol: string): Promise<ZScoreIndicators | null> {                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ     try {                                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       logger.info(`üßÆ Starting OPTIMIZED Z-Score calculation for ${symbol}`);                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Get volatility-adjusted thresholds                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const thresholds = await this.getVolatilityAdjustedThresholds();                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Get latest technical indicators                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const latest = await db.select()                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .from(technicalIndicators)                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .where(eq(technicalIndicators.symbol, symbol))                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .orderBy(desc(technicalIndicators.timestamp))                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .limit(1);                                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       if (!latest || latest.length === 0) {                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ         logger.warn(`‚ùå No technical indicators found for ${symbol}`);                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return null;                                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ       }                                                                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const latestData = latest[0];                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Calculate current indicator values (same as before)                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const currentRsi = parseFloat(latestData.rsi?.toString() || '0');                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const currentMacd = parseFloat(latestData.macd?.toString() || '0');                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const currentPercentB = parseFloat(latestData.percent_b?.toString() || '0');                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const currentAtr = parseFloat(latestData.atr?.toString() || '0');                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const currentPriceChange = parseFloat(latestData.willr?.toString() || '0'); // Placeholder                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // MA Trend calculation                                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const sma20 = parseFloat(latestData.sma_20?.toString() || '0');                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const sma50 = parseFloat(latestData.sma_50?.toString() || '0');                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const currentMaTrend = sma50 !== 0 ? sma20 / sma50 : 1;                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Get historical data for rolling statistics (same window logic)                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const cutoffDate = new Date();                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ       cutoffDate.setDate(cutoffDate.getDate() - this.ZSCORE_WINDOW);                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const historicalData = await db.select()                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .from(technicalIndicators)                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .where(                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ           and(                                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ             eq(technicalIndicators.symbol, symbol),                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ             gte(technicalIndicators.timestamp, cutoffDate)                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ           )                                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ         )                                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ         .orderBy(technicalIndicators.timestamp);                                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       if (historicalData.length < 30) {                                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ         logger.warn(`‚ùå Insufficient historical data for ${symbol}: ${historicalData.length} records`);                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return null;                                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ       }                                                                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Calculate rolling statistics for each indicator                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const rsiValues = historicalData.map(d => parseFloat(d.rsi?.toString() || '0')).filter(v => v > 0);                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const macdValues = historicalData.map(d => parseFloat(d.macd?.toString() || '0')).filter(v => isFinite(v));                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const percentBValues = historicalData.map(d => parseFloat(d.percent_b?.toString() || '0')).filter(v => isFinite(v));                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const atrValues = historicalData.map(d => parseFloat(d.atr?.toString() || '0')).filter(v => v > 0);                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // MA Trend historical values                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const maTrendValues = historicalData.map(d => {                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ         const sma20 = parseFloat(d.sma_20?.toString() || '0');                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         const sma50 = parseFloat(d.sma_50?.toString() || '0');                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         return sma50 !== 0 ? sma20 / sma50 : 1;                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       }).filter(v => isFinite(v) && v > 0);                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Price change calculation (simplified)                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const priceValues = historicalData.map(d => parseFloat(d.willr?.toString() || '0')).filter(v => isFinite(v));                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Calculate statistics                                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const rsiStats = this.calculateStats(rsiValues);                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const macdStats = this.calculateStats(macdValues);                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const bollingerStats = this.calculateStats(percentBValues);                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const atrStats = this.calculateStats(atrValues);                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const maTrendStats = this.calculateStats(maTrendValues);                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const priceStats = this.calculateStats(priceValues);                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Calculate Z-scores                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const rsiZScore = this.calculateZScore(currentRsi, rsiStats.mean, rsiStats.stdDev);                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const macdZScore = this.calculateZScore(currentMacd, macdStats.mean, macdStats.stdDev);                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const bollingerZScore = this.calculateZScore(currentPercentB, bollingerStats.mean, bollingerStats.stdDev);                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const atrZScore = this.calculateZScore(currentAtr, atrStats.mean, atrStats.stdDev);                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const maTrendZScore = this.calculateZScore(currentMaTrend, maTrendStats.mean, maTrendStats.stdDev);                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const priceMomentumZScore = this.calculateZScore(currentPriceChange, priceStats.mean, priceStats.stdDev);                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // OPTIMIZED composite Z-score calculation with new weights                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const rawCompositeZScore = (                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         (rsiZScore !== null ? this.weights.rsi * this.zscoreToSignal(rsiZScore) : 0) +                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ         (macdZScore !== null ? this.weights.macd * this.zscoreToSignal(macdZScore) : 0) +                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Keep Bollinger inversion but with reduced weight                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ         (bollingerZScore !== null ? this.weights.bollinger * this.zscoreToSignal(-bollingerZScore) : 0) +                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ         (maTrendZScore !== null ? this.weights.maTrend * this.zscoreToSignal(maTrendZScore) : 0) +                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         (priceMomentumZScore !== null ? this.weights.priceMomentum * this.zscoreToSignal(priceMomentumZScore) : 0)                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ       );                                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Apply ATR volatility modifier                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const compositeZScore = this.applyAtrModifier(rawCompositeZScore, atrZScore);                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // OPTIMIZED signal generation with dynamic thresholds                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ       let signal: 'BUY' | 'SELL' | 'HOLD' = 'HOLD';                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ       if (compositeZScore >= thresholds.buy) signal = 'BUY';                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ       else if (compositeZScore <= thresholds.sell) signal = 'SELL';                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       const result: ZScoreIndicators = {                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         symbol,                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         date: latestData.timestamp,                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Original indicators                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         rsi: currentRsi,                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         macd: currentMacd,                                                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         percentB: currentPercentB,                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         atr: currentAtr,                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         priceChange: currentPriceChange,                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         maTrend: currentMaTrend,                                                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Z-Score normalized indicators                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         rsiZScore,                                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         macdZScore,                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ         bollingerZScore,                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         atrZScore,                                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         priceMomentumZScore,                                                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         maTrendZScore,                                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Composite signal                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ         compositeZScore,                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         signal,                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         signalStrength: Math.abs(compositeZScore)                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ       };                                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       // Store in database                                                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ       await this.storeZScoreData(result);                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ       logger.info(`‚úÖ OPTIMIZED Z-Score calculation completed for ${symbol}: ${signal} (${compositeZScore.toFixed(4)}) with dynamic threshold ¬±${thresholds.buy}`);                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ       return result;                                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     } catch (error) {                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       logger.error(`‚ùå Error in optimized Z-Score calculation for ${symbol}:`, error);                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       return null;                                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * Calculate statistical measures (same as before)                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private calculateStats(values: number[]): { mean: number; stdDev: number; count: number } {                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ     if (values.length === 0) {                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ       return { mean: 0, stdDev: 1, count: 0 };                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     const mean = values.reduce((sum, val) => sum + val, 0) / values.length;                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ     const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / (values.length - 1);                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ     const stdDev = Math.sqrt(variance);                                                                                                                                                                                                                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     return {                                                                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ       mean,                                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ       stdDev: stdDev || 1, // Prevent division by zero                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ       count: values.length                                                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ     };                                                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * Store Z-score data in database (same as before)                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   private async storeZScoreData(data: ZScoreIndicators): Promise<void> {                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ     try {                                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       await db.insert(zscoreTechnicalIndicators).values({                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ         symbol: data.symbol,                                                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         date: data.date,                                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Original indicators                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         rsi: data.rsi?.toString(),                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         macd: data.macd?.toString(),                                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ         percentB: data.percentB?.toString(),                                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         atr: data.atr?.toString(),                                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         priceChange: data.priceChange?.toString(),                                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         maTrend: data.maTrend?.toString(),                                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Z-Score normalized indicators                                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ         rsiZScore: data.rsiZScore?.toString(),                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         macdZScore: data.macdZScore?.toString(),                                                                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ         bollingerZScore: data.bollingerZScore?.toString(),                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         atrZScore: data.atrZScore?.toString(),                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         priceMomentumZScore: data.priceMomentumZScore?.toString(),                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ         maTrendZScore: data.maTrendZScore?.toString(),                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Composite signal                                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ         compositeZScore: data.compositeZScore?.toString(),                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ         signal: data.signal,                                                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ         signalStrength: data.signalStrength?.toString(),                                                                                                                                                                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         // Metadata                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ         lookbackPeriod: this.ZSCORE_WINDOW,                                                                                                                                                                                                                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ         dataQuality: 'optimized',                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         createdAt: new Date(),                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ         updatedAt: new Date()                                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ       }).onConflictDoUpdate({                                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ         target: [zscoreTechnicalIndicators.symbol, zscoreTechnicalIndicators.date],                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ         set: {                                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ           compositeZScore: data.compositeZScore?.toString(),                                                                                                                                                                                                             ‚îÇ ‚îÇ
‚îÇ ‚îÇ           signal: data.signal,                                                                                                                                                                                                                                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ           signalStrength: data.signalStrength?.toString(),                                                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ           updatedAt: new Date()                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ         }                                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ       });                                                                                                                                                                                                                                                                ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     } catch (error) {                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ       logger.error('‚ùå Error storing optimized Z-score data:', error);                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ     }                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   /**                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ    * Process multiple symbols with optimized formula                                                                                                                                                                                                                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ    */                                                                                                                                                                                                                                                                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ   async processMultipleSymbols(symbols: string[]): Promise<void> {                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ     logger.info(`üöÄ Starting OPTIMIZED Z-Score processing for ${symbols.length} symbols`);                                                                                                                                                                               ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     const results = await Promise.allSettled(                                                                                                                                                                                                                            ‚îÇ ‚îÇ
‚îÇ ‚îÇ       symbols.map(symbol => this.calculateZScoreForSymbol(symbol))                                                                                                                                                                                                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ     );                                                                                                                                                                                                                                                                   ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     const successful = results.filter(r => r.status === 'fulfilled' && r.value !== null).length;                                                                                                                                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ     const failed = results.length - successful;                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ     logger.info(`‚úÖ OPTIMIZED Processing complete: ${successful} successful, ${failed} failed`);                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ   }                                                                                                                                                                                                                                                                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ }                                                                                                                                                                                                                                                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                                                                                                                                                                                                                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ export { OptimizedZScoreTechnicalService };