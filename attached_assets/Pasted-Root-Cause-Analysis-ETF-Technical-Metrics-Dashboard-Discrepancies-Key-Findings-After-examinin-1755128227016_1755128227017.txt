Root Cause Analysis: ETF Technical Metrics Dashboard Discrepancies

  Key Findings

  After examining your codebase, I've identified several critical issues
  that explain the discrepancies in your ETF Technical Metrics dashboard:

  1. MACD Calculation Issues

  - Location: /server/services/data-conversion-service.ts:213-226
  - Problem: Incomplete MACD implementation
    - Missing signal line calculation (line 225: signal: null)
    - Uses raw MACD value instead of standardized Z-score
    - No histogram calculation for divergence analysis

  2. RSI Calculation Problems

  - Location: /server/services/data-conversion-service.ts:193-211
  - Problem: Simplified RSI calculation
    - Uses simple average instead of exponential smoothing
    - Period calculation doesn't match Wilder's original RSI formula
    - Should use: avgGain = (prevAvgGain * 13 + gain) / 14

  3. Bollinger %B Calculation Errors

  - Location: /server/services/data-conversion-service.ts:245-271
  - Problem: Incorrect variance calculation
    - Line 257: Uses population variance instead of sample variance
    - Should divide by (period - 1) not period
    - Z-score inversion issue in
  /server/services/zscore-technical-service.ts:436

  4. Z-Score Display Confusion

  - Location: /server/services/zscore-technical-service.ts:423-429
  - Problem: Multiple Z-score values being mixed
    - Dashboard shows macdZScore but may be displaying raw MACD values
    - Z-score normalization uses medium-term (252-day) window, not standard
   parameters
    - Different periods than your verification (which uses standard
  settings)

  5. Data Source Issues

  - Location: /server/services/etf-metrics-service.ts:274-311
  - Problem: Stale or incomplete data
    - Falls back to cached/sector data when recent database data
  unavailable
    - Uses 7-day lookback which may miss recent market data
    - No validation that technical indicators match price timestamps

⏺ Update Todos
  ⎿  ☒ Examine the codebase structure in financehub_pro_v21_complete
     ☒ Locate ETF technical metrics calculation code
     ☒ Identify data sources and calculation parameters
     ☒ Compare calculation logic with standard formulas
     ☒ Identify root cause of discrepancies
     ☐ Create fix plan with specific changes needed

⏺ Fix Plan

  Priority 1: Critical Calculation Fixes

  1. Fix MACD Calculation -
  /server/services/data-conversion-service.ts:213-226
    - Implement proper signal line calculation (9-period EMA of MACD line)
    - Add MACD histogram calculation
    - Ensure 12/26 period EMAs match standard calculations
  2. Fix RSI Calculation -
  /server/services/data-conversion-service.ts:193-211
    - Implement Wilder's exponential smoothing method
    - Use proper 14-period lookback with exponential weighting
    - Validate against standard RSI formula
  3. Fix Bollinger %B Calculation -
  /server/services/data-conversion-service.ts:257
    - Change variance calculation from population to sample variance
    - Update line 257: / (period - 1) instead of / period

  Priority 2: Z-Score Standardization

  4. Standardize Z-Score Parameters -
  /server/services/zscore-technical-service.ts:67-73
    - Use standard calculation windows: MACD (26), RSI (14), Bollinger (20)
    - Remove custom multi-horizon windows for dashboard display
    - Align with industry standard parameters
  5. Fix Z-Score Display Logic - /client/src/components/ETFMetricsTable.tsx
    - Ensure dashboard displays actual calculated values, not Z-scores
    - Show raw MACD values in MACD column, Z-scores in separate Z-Score
  column

  Priority 3: Data Quality Improvements

  6. Improve Data Freshness - /server/services/etf-metrics-service.ts:276
    - Reduce lookback from 7 days to 1-2 days for technical indicators
    - Add data timestamp validation
    - Implement data quality checks before calculation
  7. Add Calculation Verification
    - Create unit tests comparing calculations against known values
    - Add logging to track when fallback data is used
    - Implement data source provenance tracking

⏺ Update Todos
  ⎿  ☒ Examine the codebase structure in financehub_pro_v21_complete
     ☒ Locate ETF technical metrics calculation code
     ☒ Identify data sources and calculation parameters
     ☒ Compare calculation logic with standard formulas
     ☒ Identify root cause of discrepancies
     ☒ Create fix plan with specific changes needed

⏺ Implementation Estimate

  - Critical fixes: 2-3 hours
  - Z-score standardization: 1-2 hours
  - Data quality improvements: 2-4 hours
  - Testing and validation: 1-2 hours

  Total effort: 6-11 hours

  The discrepancies in your dashboard stem from calculation errors in core
  technical indicators and confusion between raw indicator values and their
   Z-score normalizations. The fixes above will align your calculations
  with standard financial analysis practices and match the verified values
  you provided.